<script>
  // Load Mia's last cue
  function loadMiaCue() {
    const cue = JSON.parse(localStorage.getItem("miaCue"));
    const status = document.getElementById("cue-status");
    if (status) {
      if (cue) {
        status.innerText = `Last cue received: "${cue.message}" at ${cue.timestamp}`;
        if (Notification.permission === "granted") {
          new Notification("Mia Cue Received", {
            body: `"${cue.message}" at ${cue.timestamp}`,
            icon: "/assets/icon.png"
          });
        }
      } else {
        status.innerText = "No cue received yet.";
      }
    } else {
      console.warn("Element #cue-status not found.");
    }
  }

  let employees = [];

  function generateToken(name, expiry = null) {
    const tokenData = {
      name,
      issued: new Date().toISOString(),
      role: "employee"
    };
    if (expiry) tokenData.expires = expiry;
    return btoa(JSON.stringify(tokenData));
  }

  function renderEmployees() {
    const list = document.getElementById("employeeList");
    list.innerHTML = "";
    employees.forEach(emp => {
      const li = document.createElement("li");
      li.innerHTML = `
        ${emp.name} — <strong>${emp.status}</strong> —
        <button onclick="lockAccess('${emp.name}')">🔒 Lock</button>
        <button onclick="removeAccess('${emp.name}')">❌ Remove</button>
        <button onclick="showQR('${emp.name}')">📎 QR</button>
      `;
      list.appendChild(li);
    });
  }

  function addEmployee() {
    const name = document.getElementById("newName").value.trim();
    if (name) {
      const token = generateToken(name);
      employees.push({ name, status: "active", token });
      logAudit(`Added ${name}`);
      renderEmployees();
      document.getElementById("newName").value = "";
    }
  }

  function lockAccess(name) {
    employees = employees.map(emp =>
      emp.name === name ? { ...emp, status: "locked" } : emp
    );
    logAudit(`Locked ${name}`);
    renderEmployees();
  }

  function removeAccess(name) {
    employees = employees.filter(emp => emp.name !== name);
    logAudit(`Removed ${name}`);
    renderEmployees();
    document.getElementById("qrPreview").innerHTML = "";
  }

  function showQR(name) {
    const emp = employees.find(e => e.name === name);
    if (!emp) return;

    const url = `https://www.hufflesitservices.online/Employee/dashboard-daddy.html?token=${emp.token}`;
    const qr = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}`;

    document.getElementById("qrPreview").innerHTML = `
      <h3>QR Code for ${name}</h3>
      <img src="${qr}" alt="QR Code for ${name}" />
      <p><a href="${url}" target="_blank">${url}</a></p>
    `;
  }

  function logAudit(action) {
    const list = document.getElementById("auditList");
    const li = document.createElement("li");
    li.innerText = `${new Date().toLocaleString()}: ${action}`;
    list.prepend(li);
  }

  function detectMasterToken() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("token");
    if (!token) return;

    try {
      const decoded = JSON.parse(atob(token));
      if (decoded.role === "master") {
        document.body.classList.add("master-mode");
        logAudit("Master token detected — full access granted.");
      }
    } catch (e) {
      console.warn("Invalid token format.");
    }
  }

  function requestNotificationPermission() {
    if ("Notification" in window) {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          logAudit("Push notifications enabled.");
        } else {
          logAudit("Push notifications denied or dismissed.");
        }
      });
    }
  }

  window.onload = () => {
    detectMasterToken();
    loadMiaCue();
    renderEmployees();
    requestNotificationPermission();
  };
</script>

<!-- 🔔 Service Worker Registration -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/assets/service-worker.js')
      .then(reg => console.log('Service Worker registered:', reg))
      .catch(err => console.error('Service Worker registration failed:', err));
  }
</script>
