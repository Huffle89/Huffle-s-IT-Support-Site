<script>
  // Load Mia's last cue
  function loadMiaCue() {
    const cue = JSON.parse(localStorage.getItem("miaCue"));
    const status = document.getElementById("cue-status");
    if (cue) {
      status.innerText = `Last cue received: "${cue.message}" at ${cue.timestamp}`;
    } else {
      status.innerText = "No cue received yet.";
    }
  }

  let employees = [];

  function generateToken(name, expiry = null) {
    const tokenData = {
      name,
      issued: new Date().toISOString(),
      role: "employee"
    };
    if (expiry) tokenData.expires = expiry;
    return btoa(JSON.stringify(tokenData));
  }

  function renderEmployees() {
    const list = document.getElementById("employeeList");
    list.innerHTML = "";
    employees.forEach(emp => {
      const li = document.createElement("li");
      li.innerHTML = `
        ${emp.name} — <strong>${emp.status}</strong> —
        <button onclick="lockAccess('${emp.name}')">🔒 Lock</button>
        <button onclick="removeAccess('${emp.name}')">❌ Remove</button>
        <button onclick="showQR('${emp.name}')">📎 QR</button>
      `;
      list.appendChild(li);
    });
  }

  function addEmployee() {
    const name = document.getElementById("newName").value.trim();
    if (name) {
      const token = generateToken(name);
      employees.push({ name, status: "active", token });
      logAudit(`Added ${name}`);
      renderEmployees();
      document.getElementById("newName").value = "";
    }
  }

  function lockAccess(name) {
    employees = employees.map(emp =>
      emp.name === name ? { ...emp, status: "locked" } : emp
    );
    logAudit(`Locked ${name}`);
    renderEmployees();
  }

  function removeAccess(name) {
    employees = employees.filter(emp => emp.name !== name);
    logAudit(`Removed ${name}`);
    renderEmployees();
    document.getElementById("qrPreview").innerHTML = "";
  }

  function showQR(name) {
    const emp = employees.find(e => e.name === name);
    if (!emp) return;

    const url = `https://www.hufflesitservices.online/Employee/dashboard-template.html?token=${emp.token}`;
    const qr = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}`;

    document.getElementById("qrPreview").innerHTML = `
      <h3>QR Code for ${name}</h3>
      <img src="${qr}" alt="QR Code for ${name}" />
      <p><a href="${url}" target="_blank">${url}</a></p>
    `;
  }

  function logAudit(action) {
    const list = document.getElementById("auditList");
    const li = document.createElement("li");
    li.innerText = `${new Date().toLocaleString()}: ${action}`;
    list.prepend(li);
  }

  window.onload = () => {
    loadMiaCue();
    renderEmployees();
  };
</script>

<!-- 🔔 Service Worker Registration -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/assets/service-worker.js')
      .then(reg => console.log('Service Worker registered:', reg))
      .catch(err => console.error('Service Worker registration failed:', err));
  }
</script>
